# DO NOT EDIT THIS FILE! EDIT 'create-pr.jinja.yaml'.

# This file is a part of Kurt McKee's GitHub Workflows project.
# https://github.com/kurtmckee/github-workflows
# Copyright 2024-2026 Kurt McKee <contactme@kurtmckee.org>
# SPDX-License-Identifier: MIT

on:
  workflow_call:
    inputs:
      config:
        type: "string"
        required: true
        description: |
          The configuration object.
      version:
        type: "string"
        required: false
        description: |
          The version to use when creating the release.

          This must be a valid version specifier (see PEP 440),
          but the workflow itself doesn't currently validate the version.

          The version can be referenced in several configuration variables
          by using the name `$VERSION`:

          * `branch-name` (example: `release/$VERSION`)
          * `commit-title` (example: `Update metadata for v$VERSION`)
          * `pr-title` (example: `Release v$VERSION`)

          The version will also be available as an environment variable when tox is run:

          ```
          poetry version "$VERSION"
          ```

          Remember to set the tox `pass_env` configuration value to pass `VERSION`.


env:
  PYTHON_VERSION: "3.13"
  UV_VERSION: "0.10.6"
  PANDOC_VERSION: "3.8.3"
  CHECK_JSONSCHEMA_REQUIREMENTS: |
    attrs==25.4.0 ; python_version == "3.13"
    certifi==2026.2.25 ; python_version == "3.13"
    charset-normalizer==3.4.4 ; python_version == "3.13"
    check-jsonschema==0.36.2 ; python_version == "3.13"
    click==8.3.1 ; python_version == "3.13"
    colorama==0.4.6 ; python_version == "3.13" and platform_system == "Windows"
    idna==3.11 ; python_version == "3.13"
    jsonschema-specifications==2025.9.1 ; python_version == "3.13"
    jsonschema==4.26.0 ; python_version == "3.13"
    referencing==0.37.0 ; python_version == "3.13"
    regress==2025.10.1 ; python_version == "3.13"
    requests==2.32.5 ; python_version == "3.13"
    rpds-py==0.30.0 ; python_version == "3.13"
    ruamel-yaml==0.19.1 ; python_version == "3.13"
    urllib3==2.6.3 ; python_version == "3.13"
  TOX_REQUIREMENTS: |
    cachetools==7.0.1 ; python_version == "3.13"
    colorama==0.4.6 ; python_version == "3.13"
    distlib==0.4.0 ; python_version == "3.13"
    filelock==3.24.3 ; python_version == "3.13"
    packaging==26.0 ; python_version == "3.13"
    platformdirs==4.9.2 ; python_version == "3.13"
    pluggy==1.6.0 ; python_version == "3.13"
    pyproject-api==1.10.0 ; python_version == "3.13"
    python-discovery==1.0.0 ; python_version == "3.13"
    tox-gh==1.7.1 ; python_version == "3.13"
    tox-uv-bare==1.33.0 ; python_version == "3.13"
    tox-uv==1.33.0 ; python_version == "3.13"
    tox==4.46.3 ; python_version == "3.13"
    uv==0.10.6 ; python_version == "3.13"
    virtualenv==21.0.0 ; python_version == "3.13"

  # These values are used when a config value is not specified.
  default-branch-from: "main"
  default-branch-name: "updates"
  default-commit-title: "Updates"
  default-pr-base: "main"
  default-pr-title: "Updates"
  default-pr-body-input-format: "rst"

jobs:
  create-pr:
    name: "create-pr"
    runs-on: "ubuntu-24.04"
    permissions:
      contents: "write"
      pull-requests: "write"
    steps:
      - name: "Export config"
        id: "config-exporter"
        shell: "bash"
        # Loading the input from an environment variable avoids injection attacks.
        env:
          inputs_config: "${{ inputs.config }}"
        run: |
          echo "$inputs_config" > ".create-pr-config.raw.json"

      - name: "Setup Python for base requirements"
        uses: "actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405" # v6.2.0
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        with:
          python-version: "${{ env.PYTHON_VERSION }}"

      - name: "Install uv"
        uses: "astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867" # v7.1.6
        with:
          version: "${{ env.UV_VERSION }}"
          enable-cache: "false"
          ignore-empty-workdir: "true"

      # If a previous workflow run successfully validated an identical config object,
      # a cache hit is sufficient to demonstrate that no further validation is required.
      - name: "Check if raw config is already validated"
        id: "lookup-config-cache"
        uses: "actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306" # v5.0.3
        with:
          lookup-only: true
          path: ".create-pr-config.raw.json"
          key: "create-pr-config-${{ hashFiles('.create-pr-config.raw.json') }}"

      - name: "Write config schema"
        if: "${{ steps.lookup-config-cache.outputs.cache-hit == false }}"
        shell: "bash"
        env:
          CONFIG_SCHEMA: |
            {
              "$schema": "https://json-schema.org/draft-07/schema",
              "description": "This file is a part of Kurt McKee's GitHub Workflows project.\nhttps://github.com/kurtmckee/github-workflows\nCopyright 2024-2026 Kurt McKee <contactme@kurtmckee.org>.\nSPDX-License-Identifier: MIT",
              "type": "object",
              "required": [
                "tox-label-create-changes"
              ],
              "properties": {
                "python-version": {
                  "description": "The Python version to use when running tox.",
                  "type": "string",
                  "default": "3.13"
                },
                "tox-label-create-changes": {
                  "description": "The tox label (passed using the `-m` argument) to run before creating the commit. Two environment variables will be set: `VERSION` and `PR_BODY_OUTPUT_PATH`. After running tox, all file changes shown in `git status` will be included in the commit.",
                  "type": "string",
                  "minLength": 1,
                  "examples": [
                    "update",
                    "prep-release"
                  ]
                },
                "checkout-branch": {
                  "description": "The name of the branch to initially checkout.",
                  "type": "string",
                  "minLength": 1,
                  "default": "main"
                },
                "branch-name": {
                  "description": "The name of the branch to create. If a `version` input is passed to the workflow, it can be referenced as `$VERSION`.",
                  "type": "string",
                  "minLength": 1,
                  "default": "updates",
                  "examples": [
                    "release/$VERSION"
                  ]
                },
                "commit-title": {
                  "description": "The one-line commit message to use.",
                  "type": "string",
                  "minLength": 1,
                  "default": "Updates"
                },
                "pr-base": {
                  "description": "The name of the branch to merge to in the PR. This appears as the 'base' in the GitHub UI.",
                  "type": "string",
                  "minLength": 1,
                  "default": "main"
                },
                "pr-title": {
                  "description": "The title of the PR. If a `version` input is passed to the workflow, it can be referenced as `$VERSION`.",
                  "type": "string",
                  "minLength": 1,
                  "default": "Updates",
                  "examples": [
                    "Release v$VERSION"
                  ]
                },
                "pr-body": {
                  "description": "The body of the PR. If a `version` input is passed to the workflow, it can be referenced as `$VERSION`.",
                  "type": "string",
                  "minLength": 1,
                  "default": "",
                  "examples": [
                    "Scheduled updates."
                  ]
                },
                "pr-body-input-format": {
                  "description": "The format of the PR body fragment generated by the tox label that prepares releases. The value must exactly match the `--from` argument values that pandoc supports, but currently only 'gfm' and 'rst' are allowed.",
                  "type": "string",
                  "enum": [
                    "gfm",
                    "rst"
                  ],
                  "default": "rst"
                }
              }
            }
        run: |
          echo "${CONFIG_SCHEMA}" > "${RUNNER_TEMP}/config-schema.json"

      - name: "Validate the raw config against the schema"
        if: "${{ steps.lookup-config-cache.outputs.cache-hit == false }}"
        shell: "bash"
        run: |
          REQUIREMENTS_PATH="$(mktemp)"
          echo "${CHECK_JSONSCHEMA_REQUIREMENTS}" > "${REQUIREMENTS_PATH}"

          uv run \
            --no-managed-python \
            --no-project \
            --with-requirements="${REQUIREMENTS_PATH}" \
            check-jsonschema --schemafile "${RUNNER_TEMP}/config-schema.json" ".create-pr-config.raw.json"

      - name: "Create a 'config-is-validated' cache key"
        if: "${{ steps.lookup-config-cache.outputs.cache-hit == false }}"
        uses: "actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306" # v5.0.3
        with:
          path: ".create-pr-config.raw.json"
          key: "${{ steps.lookup-config-cache.outputs.cache-primary-key }}"

      - name: "Install pandoc"
        env:
          PANDOC_DEB_URL: "https://github.com/jgm/pandoc/releases/download/${{ env.PANDOC_VERSION }}/pandoc-${{ env.PANDOC_VERSION }}-1-amd64.deb"
        run: |
          wget -nv -O pandoc.deb "${PANDOC_DEB_URL}"
          sudo dpkg -i ./pandoc.deb
          rm ./pandoc.deb

      - name: "Checkout the repository"
        uses: "actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd" # v6.0.2
        with:
          ref: "${{ fromJSON(inputs.config).branch-from || env.default-branch-from }}"
          fetch-depth: 0

      - name: "Create a virtual environment"
        shell: "bash"
        run: |
          REQUIREMENTS_PATH="$(mktemp)"
          echo "${TOX_REQUIREMENTS}" > "${REQUIREMENTS_PATH}"

          uv venv --no-project --no-managed-python .venv
          echo "*" > ".venv/.gitignore"
          uv pip install --no-managed-python --directory=.venv --requirements="${REQUIREMENTS_PATH}"

      - name: "Setup the requested Python version"
        if: "${{ fromJSON(inputs.config).python-version != '' && fromJSON(inputs.config).python-version != env.PYTHON_VERSION }}"
        uses: "actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405" # v6.2.0
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        with:
          python-version: "${{ fromJSON(inputs.config).python-version }}"
          allow-prereleases: true

      - name: "Generate changes"
        env:
          PR_BODY: "${{ fromJSON(inputs.config).pr-body }}"
          PR_BODY_OUTPUT_PATH: "${{ runner.temp }}/pr-body-fragment.txt"
          VERSION: "${{ inputs.version }}"
          TOX_LABEL: "${{ fromJSON(inputs.config).tox-label-create-changes }}"
        run: |
          .venv/bin/tox run --colored yes -m "${TOX_LABEL}"

      - name: "Setup Python for commit generation"
        if: "${{ fromJSON(inputs.config).python-version != '' && fromJSON(inputs.config).python-version != env.PYTHON_VERSION }}"
        uses: "actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405" # v6.2.0
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
        with:
          python-version: "${{ env.PYTHON_VERSION }}"
          allow-prereleases: true

      - name: "Generate commit request body"
        shell: "python"
        env:
          VERSION: "${{ inputs.version }}"
          BRANCH_NAME: "${{ fromJSON(inputs.config).branch-name || env.default-branch-name }}"
          COMMIT_TITLE: "${{ fromJSON(inputs.config).commit-title || env.default-commit-title }}"
          OUTPUT_FILE: "${{ runner.temp }}/graphql-input.json"
        run: |
          # This file is a part of Kurt McKee's GitHub Workflows project.
          # https://github.com/kurtmckee/github-workflows
          # Copyright 2024-2026 Kurt McKee <contactme@kurtmckee.org>
          # SPDX-License-Identifier: MIT

          import base64
          import json
          import os
          import pathlib
          import re
          import subprocess
          import sys
          import typing

          RC_SUCCESS = 0
          RC_FAILURE = 1

          mandatory_environment_variables = {
              "BRANCH_NAME",
              "COMMIT_TITLE",
              "GITHUB_REPOSITORY",
              "GITHUB_SHA",
              "OUTPUT_FILE",
          }


          def main() -> int:
              # Ensure mandatory environment variables are present.
              if missing_keys := (mandatory_environment_variables - os.environ.keys()):
                  for missing_key in missing_keys:
                      print(f"`{missing_key}` is a mandatory environment variable.")
                  return RC_FAILURE

              # Calculate file changes (and exit if there are none).
              file_changes = calculate_file_changes()
              if not file_changes:
                  print("No file changes detected.")
                  return RC_FAILURE

              request_body = generate_request_body(file_changes)

              output_file = os.environ["OUTPUT_FILE"]
              if output_file == "-":
                  print(json.dumps(request_body, indent=2))
              else:
                  with open(output_file, "w") as file:
                      file.write(json.dumps(request_body))

              return RC_SUCCESS


          def generate_request_body(file_changes: dict[str, typing.Any]) -> dict[str, typing.Any]:
              query = """
                  mutation ($input:CreateCommitOnBranchInput!) {
                      createCommitOnBranch(input: $input) {
                          commit { oid }
                      }
                  }
              """

              return {
                  "query": " ".join(query.split()),
                  "variables": {
                      "input": {
                          "branch": {
                              "branchName": inject_version(os.environ["BRANCH_NAME"]),
                              "repositoryNameWithOwner": os.environ["GITHUB_REPOSITORY"],
                          },
                          "expectedHeadOid": os.environ["GITHUB_SHA"],
                          "fileChanges": file_changes,
                          "message": {
                              "headline": inject_version(os.environ["COMMIT_TITLE"]),
                          },
                      },
                  },
              }


          def inject_version(text: str) -> str:
              version = os.getenv("VERSION") or "VERSION_NOT_FOUND"
              return re.sub(r"\$version", version, text, flags=re.I)


          def calculate_file_changes() -> dict[str, list[dict[str, str]]]:
              cmd = "git status --no-renames --porcelain"

              additions: list[dict[str, str]] = []
              deletions: list[dict[str, str]] = []

              for line in subprocess.check_output(cmd.split()).decode().splitlines():
                  path = pathlib.Path(line[3:])

                  target = deletions
                  info = {"path": path.as_posix()}
                  if path.is_file():
                      target = additions
                      info["contents"] = base64.b64encode(path.read_bytes()).decode()
                  target.append(info)

              file_changes = {}
              if additions:
                  file_changes["additions"] = additions
              if deletions:
                  file_changes["deletions"] = deletions
              return file_changes


          if __name__ == "__main__":
              sys.exit(main())

      - name: "Push a new branch"
        env:
          VERSION: "${{ inputs.version }}"
          GH_TOKEN: "${{ github.token }}"
          COMMIT_TITLE: "${{ fromJSON(inputs.config).commit-title || env.default-commit-title }}"
        run: |
          git push origin HEAD:"${{ fromJSON(inputs.config).branch-name || env.default-branch-name }}"
          gh api graphql --input "${{ runner.temp }}/graphql-input.json"

      - name: "Generate the PR body"
        env:
          PR_BODY: "${{ fromJSON(inputs.config).pr-body }}"
          PR_BODY_PATH: "${{ runner.temp }}/pr-body-fragment.txt"
          PR_BODY_INPUT_FORMAT: "${{ fromJSON(inputs.config).pr-body-input-format || env.default-pr-body-input-format }}"
          VERSION: "${{ inputs.version }}"
        run: |
          # If a static PR body was provided, use it.
          # This unconditionally overwrites any PR body
          # that might have been created when tox ran above.
          if [ ! -z "${PR_BODY}" ]; then
              echo "${PR_BODY}" > "${PR_BODY_PATH}"
          fi

          # If a PR body file was not yet generated, create a blank one.
          if [ ! -f "${PR_BODY_PATH}" ]; then
              touch "${PR_BODY_PATH}"
          fi

          # Convert the content to GitHub-formatted Markdown.
          pandoc \
            --from "${PR_BODY_INPUT_FORMAT}" \
            --to gfm \
            --wrap preserve \
            --shift-heading-level-by 1 \
            "${PR_BODY_PATH}" \
            --output "${RUNNER_TEMP}/pr-body-fragment.gfm"

          # If a version was provided, augment the PR body with the version as its header.
          if [ ! -z "${VERSION}" ]; then
            echo "# ${VERSION}" > "${RUNNER_TEMP}/pr-body.gfm"
          fi

          cat "${RUNNER_TEMP}/pr-body-fragment.gfm" >> "${RUNNER_TEMP}/pr-body.gfm"

      - name: "Create a PR"
        env:
          VERSION: "${{ inputs.version }}"
          GH_TOKEN: "${{ github.token }}"
        run: |
          gh pr create \
            --draft \
            --head "${{ fromJSON(inputs.config).branch-name || env.default-branch-name }}" \
            --base "${{ fromJSON(inputs.config).pr-base || env.default-pr-base }}" \
            --title "${{ fromJSON(inputs.config).pr-title || env.default-pr-title }}" \
            --body-file "${RUNNER_TEMP}/pr-body.gfm"
